<HTML>

<HEAD>

<!--  formamus.htm version 02 February 1998 

      INSTRUCTIONS FOR SUBMITTING: DO NOT USE HTML EDITORS!

      SEARCH THIS TEXT FOR THE STRING "Your_" 

      AND REPLACE WITH WHATEVER YOU WANT TO PUBLISH! 

      THANKS A LOT: this will allow automated retrieval -->

<TITLE>rude45.htm Reversing packed targets</TITLE>

</HEAD>



<BODY BGCOLOR=#C0C0C0 TEXT=#001010 VLINK=#405040>

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%"  HEIGHT="22">

<TR><TD></TD>

<TD>

<!-- Choose  a TITLE probably wont be changed -->

<CENTER><FONT SIZE="+2">Reversing Packed Targets</FONT><BR>

        <FONT SIZE="+1">An Excersize in reversing for reversing's sake</FONT>

</CENTER>

</TD>



<TD>

<!-- Choose  a PROJECT GIF, leave this if unsure -->

<CENTER><A href="projunpa.htm" tppabs="http://www.anticrack.de/fravia/projunpa.htm"><IMG SRC="packers.gif" tppabs="http://www.anticrack.de/fravia/packers.gif" ALT="packers" 

ALIGN=CENTER WIDTH=114 HEIGHT=43 BORDER=0 VSPACE=0 

HSPACE=0></A>

<BR>

<FONT color=gray>Packers</FONT>

</CENTER></TD></TR>

<TR>

<TD bgcolor="#FFFFEA"><CENTER>

<FONT COLOR="890000">

<!-- CHOOSE A DATE (will probably be changed) -->

19 May 1998

</FONT></CENTER>

</TD>

<TD bgcolor="#FFFFEA"><CENTER>by <FONT size=+1>

<!-- CHOOSE A HANDLE (wont be changed) -->

The RudeBoy [PC]

</FONT></CENTER>

</TD>

<TD VALIGN="center" bgcolor="#FFFFEA">

<!--

<a href="hcu98_3.htm" tppabs="http://www.anticrack.de/fravia/hcu98_3.htm"><IMG SRC="hcu1.gif" tppabs="http://www.anticrack.de/fravia/hcu1.gif" ALT="+cracker" ALIGN=BOTTOM 

WIDTH=114 HEIGHT=43 BORDER=0 VSPACE=0 HSPACE=0></a>

-->

</TD>

</TR>

<TR><TD><CENTER><A href="index.html" tppabs="http://www.anticrack.de/fravia/index.html"><IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALIGN="BOTTOM" 

BORDER="0" VSPACE="0" HSPACE="0" width="13" height="13"></A></CENTER></TD>

<TD BGCOLOR="898030"><CENTER>Courtesy of Fravia's page of 

reverse engineering</CENTER> 

</CENTER></TD>

<TD BGCOLOR="898030">

<CENTER>

<!-- Your truly+ will edit only if really necessary -->

<PRE> </PRE></CENTER></TD>

</TR>

<!-- this is for the data.....fra_00xx....yymmdd....handle..beg+int...not ass... -->

<TR><TD><FONT color="#C4C0CF">fra_00xx<BR>980519<BR>RudeBoy<BR>0100<BR>PU<BR>PC<BR></FONT></TD><TD><I><CENTER>

Simple, yet interesting little essay about basic DOS-type unpacking skills.

</I></CENTER></TD>

<TD></TD>

</TR>

<TR><TD></TD>

<!-- Leonard Coehn's old song, because we are poets, not only crackers -->

<TD BGCOLOR="898030"><CENTER></I><B>There is a crack, a crack in everything 

That's how the light gets in</B></CENTER>

<!-- Leonard Coehn's old song, because we are poets, not only crackers -->

</CENTER></TD><TD></TD>

</TR>

<TR>

<TD VALIGN= "MIDDLE" bgcolor="#C6E7C6"><FONT color=blue><CENTER>

Rating</FONT></FONT></CENTER>

</TD>

<TD VALIGN = "MIDDLE" bgcolor="#C6E7C6"><FONT color=blue><CENTER>

<!-- CHOOSE A RATING (may be changed) -->

( )<B>Beginner</B> (X)<B>Intermediate</B> ( )<B>Advanced</B> ( )<B>Expert</B></FONT>

</CENTER></TD>

<TD></TD>

</TR>

</TABLE>

<!-- END HEAD  -->

<BR>

<!-- CORPUS  -->



<!-- CHOOSE A COMMENT (may be changed)  -->

An essay discussing simple .com file packing and unpacking

<HR>

<CENTER>

   <FONT SIZE="+2">

<!-- CHOOSE A TITLE (wont probably be changed) -->

Reversing Packed Targets

   </FONT><BR>

   <FONT SIZE="+2">

<!-- CHOOSE A SUBTITLE (wont proabbly be changed) -->

An Excersize in reversing for reversing's sake

   </FONT><BR>

   <FONT COLOR="0B7FC1">

<!-- REPEAT YOUR CHOSEN HANDLE HERE -->Written by 

The RudeBoy [PC]

   </FONT>

</CENTER><BR><BR>



<!-- INTRO STARTS HERE -->

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%"  HEIGHT="22" >

<TR><TD bgcolor="#C6E7C6"><CENTER><FONT size=+2><FONT color=blue>Introduction</FONT>

</FONT></CENTER></TD></TR></TABLE>

<PRE>

This essay is meant to explain .com file packing and unpacking.

Not much else to say...

</PRE>

<BR><BR>



<!-- TOOLS STARTS HERE -->

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%"  HEIGHT="22" >

<TR><TD bgcolor="#C6E7C6"><CENTER><FONT size=+2><FONT color=blue>Tools required</FONT>

</FONT></CENTER></TD></TR></TABLE>

TRacer 1.98<BR>

IDA 3.7x<BR>

C Compiler (optional)<BR>

Hex Editor (optional)<BR>

PKLite

<BR><BR>



<!-- TARGET URL STARTS HERE -->

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%"  HEIGHT="22" >

<TR><TD bgcolor="#C6E7C6"><CENTER><FONT size=+2><FONT color=blue>Target's URL/FTP</FONT>

</FONT></CENTER></TD></TR></TABLE>

<!-- DON'T FORGET TO PASTE HERE THE URL/FTP OF YOUR TARGET(S) -->

<A href="javascript:if(confirm('http://fravia.org/rbcrk.zip  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://fravia.org/rbcrk.zip'" tppabs="http://fravia.org/rbcrk.zip">rb15fcrk.com</A> - f's crack for ReBirth 1.5

<BR><BR>



<!-- PROGRAM HISTORY STARTS HERE -->

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%"  HEIGHT="22" >

<TR><TD bgcolor="#C6E7C6"><CENTER><FONT size=+2><FONT color=blue>Program History</FONT>

</FONT></CENTER></TD></TR></TABLE>

Not Important

<BR><BR>



<!-- REAL ESSAY  STARTS HERE -->

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%"  HEIGHT="22" >

<TR><TD bgcolor="#C6E7C6"><CENTER><FONT size=+2><FONT color=blue>Essay</FONT></FONT>

</CENTER></TD></TR></TABLE>

<!-- PASTE HERE THE TEXT OF YOUR ESSAY

     THIS IS OF COURSE THE MOST IMPORTANT PART

     PLEASE CHECK THE MARGINS WHEN YOU ARE FINISHED! 

     SHOULD NOT BLAST NETSCAPE MARGINS OUT! HAVE A LOOK INSIDE

     YOUR OWN BROWSER WHEN YOU HAVE FINISHED!  -->

<PRE>

A friend of mine downloaded this crack off the web so that he could better evaluate

ReBirth.  He sent it to me as well, and when I ran it I noticed that it had a "nag".

In order to run the patch, you had to hit the "Page Up" key.  I decided that I would 

remove the nag from this program.



To do this, i started up IDA and loaded the .com file.  What I saw was interesting. 

The program started off with a jmp, followed by a bunch of data that seemed to make

no sense.  Generally this is a good sign that the file is packed.  I now had a few 

options: i could try a generic unpacker (and learn nothing in the process), i could

use TR or debug to unpack the prog (and learn nothing), or, i could reverse the 

unpacking routine and write my own unpacker for this kind of file.  I decided to go

for the third option.



To reverse the unpacking routine, I followed the jump at the entry point.  The first

thing it does is check the DOS version, then jumps to the next part of the code regardless

of what version of DOS is running.  This is where we want to start paying attention:



<CODE>

loc_0_3576:				

		mov	bx, 10h     ; 

		add	bx, 0F0h    ; 10h + F0h = 100h*

		push	bx      

		mov	al, 0AAh    ; Encryption key into al

		add	al, 7	    ; change the key by adding 7

		push	cx

		mov	cx, 3465h   ; # of bytes to decrypt into cx



loc_0_3586:	

		jmp	loc_0_358A  ; jmp to decryption loop

; ŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸ

		db 0EAh	; Í

; ŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸŸ



loc_0_358A:				

		xor	cs:[bx], al ; xor the byte at cs:[bx] with our encryption key

		push	si      ; random code

		mov	si, 64h     ; ??

		sub	si, 27DBh   ; ??

		pop	bp		    ; ??	

		inc	al          ; increment the encryption key

		inc	bx          ; look at the next byte in the program

		loop	loc_0_3586 ; loop until all bytes have been processed

</CODE>

* 100h is the starting location in memory of a .com file



So this code is pretty simple, get the encryption key, xor a byte by it, increment

the encryption key, and use it tdecryptpt the next byte in the file.

If thencryptionon routine ended here there would be a problem.  When the program is

packed, The first 3 bytes are changed to a jmp to this section of code.  Xor'ing this

jump by the encryption key will still leave us with 3 odd bytes at the start of the file.

So we go to the next section of the code:



<CODE>

		mov	bx, 100h

		mov	word ptr [bx], 0F0B8h

		mov	byte ptr [bx+2], 80h

</CODE>



Simple enough, the packer stores the first 3 bytes directly in the decryption routine.

Now, to write our own unpacker for these files.  I used C to do this, but you can use

whatever language is comfortable to you.  You can take at a look at the source to my

unpacker <A href="#src">here</A>.



Now, on to removing that nag...

Wait, this file is packed again...this time with PKLite.  Reversing PKLite is beyond

the scope of this essay, but PKLite has an option built into it to decompress packed

files. Just run pklite -x [filename] and the file is now unpacked.



Again, on to removing the nag...but wait, the file is packed yet again...

This time the file is compressed with the same packer used the first time, so, if you

wrote your unpacker properly you can make short work of this final layer of packing.



Now time to *finally* remove the nag.  IDA does not produce a very usable listing for 

this prog, so fire up TR, and step through this prog.  You will find a few sections

of code dedicated to printing characters and strings to the screen, then a few 

memory allocation calls then:



<CODE>

		mov	ds, cs:word_0_2B9	; setting up a far call

		push	ds			;

		pop	es			;

		assume es:seg000		;

		call	dword ptr cs:unk_0_2B7  ; NagUser();

</CODE>



Trace into the NagUser() function and here is what you will see:



<CODE>

		or	ax, ax	    ;Test value in ax

		jz	loc_0_BA4   ;jump

		clc	

		retf	

loc_0_BA4:				

		xor	ax, ax

		int	16h	    ; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY

				    ; Return: AH = scan code, AL = character

		cmp	ah, 49h	    ; compare the key pressed to "Page Up"

		jz	loc_0_BAF   ; jump if equal

</CODE>

Bingo! That's the code we're looking for. In order to kill the nag, we have to do

two things. First, stop the int 16h, because it waits for a keypress.  Second, force

the jz after the compare to always jump.  There are many ways to do these things, I

will let you figure them out for yourself.



<A name="src"></A>

<CODE>

/*********************************************************************************

	funp.cpp

	Unpacker for "f" encrypted .com files

	This code is not very neat...i threw it together pretty quickly, so please

	excuse the sloppyness.<XMP>

*********************************************************************************/

#include <STDIO.h>

#include <STDLIB.h>



void main (int argc, char *argv[]) {

    FILE *packed, *unpacked;

	int codeloc, count, i, curbyte;

	char key;

	printf("f-Unpacker by The RudeBoy [PC]\n");

	if (argc <3)

	{

		printf("USAGE: funp [packed file] [unpacked file]\n");

		exit(-1);

	}

	// Open the files

    if((packed = fopen(argv[1], "rb")) == NULL){

        printf("Error: cannot locate %s\n", argv[1]);

        exit(-1);

    }                

	if ((unpacked = fopen(argv[2], "wb")) == NULL)

	{

        printf("Error: cannot open %s\n", argv[2]);

        exit(-1);

	}



	//Seek in one byte, to get the location of the decryption code

	"if(fseek(packed,1.class" tppabs="http://fravia.org/if(fseek(packed,1.class" , SEEK_SET)){

        printf("Error in %s: cannot seek to 0x1\n", argv[1]);

        exit(-1);

    }

	codeloc = 0;

	//Get the location of the decryption code (relative to the current location in the file)

	if( fread(&codeloc, sizeof(short), 1, packed) != 1)

	{

		printf("Error in %s: could not read data\n", argv[1]);

		exit(-1);

	}

	codeloc += 3; //So we have the total length from the start of the file to the code

	if(fseek(packed,codeloc + 0x17 , SEEK_SET)){

        printf("Error in %s: cannot seek to 0x%X\n", argv[1], codeloc);

        exit(-1);

    }

	//Get the initial decryption key

	if( fread(&key, sizeof(char), 1, packed) != 1)

	{

		printf("Error in %s: could not read data\n", argv[1]);

		exit(-1);

	}

	//add 7

	key += 7;

	count = 0;

	if(fseek(packed,codeloc + 0x1C , SEEK_SET)){

        printf("Error in %s: cannot seek to 0x%X\n", argv[1], codeloc);

        exit(-1);

    }

	//Get the number of encrypted bytes

	if( fread(&count, sizeof(short), 1, packed) != 1)

	{

		printf("Error in %s: could not read data\n", argv[1]);

		exit(-1);

	}

	//Go to the beginning of the file to start the decryption

    fseek(packed,0 , SEEK_SET);

	//Decryption loop

	for(i = 1;i<=count;i++)

	{

		//Get the next byte from the packed file

		curbyte = fgetc(packed);

		//xor it by the key

		curbyte ^= key;

		//and write it to the decrypted file

		fputc( curbyte, unpacked);

		//increment the key, or make it 0 if it equals 0xFF

		if(key == 0xFF)

			key = 0;

		else

			key++;

	}

	//Go to the location in the packed file where the "real" first 3 bytes are found

	if(fseek(packed,codeloc + 0x38 , SEEK_SET)){

        printf("Error in %s: cannot seek to 0x%X\n", argv[1], codeloc);

        exit(-1);

    }

	fseek(unpacked,0 , SEEK_SET);

	//Get each of those bytes and write them to the unpacked file

	curbyte = fgetc(packed);

    fputc( curbyte, unpacked);

	curbyte = fgetc(packed);

    fputc( curbyte, unpacked);

	fseek(packed,3 , SEEK_CUR);

	curbyte = fgetc(packed);

    fputc( curbyte, unpacked);

	

	//close the files

    fclose(packed);

    fclose(unpacked);

	

	printf("Done.\n");



}

//----------------------------------------------------------------------------------

</xmp>

</CODE>

</PRE>

<BR><BR>





<!-- OB DUH STARTS HERE -->

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%"  HEIGHT="22" >

<TR><TD bgcolor="#C6E7C6"><CENTER><FONT size=+2><FONT color=blue>Ob Duh</FONT></FONT>

</CENTER></TD></TR></TABLE>

 <CENTER>

   <I>Ob duh doesn't apply, it's reversing for reversing sake , here</I>

</CENTER>



<!-- WAY OUT STARTS HERE -->

<HR>

<CENTER><I>You are deep inside fravia's page of reverse engineering,  

choose your way out:</I></CENTER>

<BR><CENTER>

<!-- EITHER A NICE GIF LIKE THIS -->





<A href="projunpa.htm" tppabs="http://www.anticrack.de/fravia/projunpa.htm"><IMG SRC="packers.gif" tppabs="http://www.anticrack.de/fravia/packers.gif" 

ALT="projunpa" ALIGN=CENTER WIDTH=114 HEIGHT=43 BORDER=0 VSPACE=0 HSPACE=0></A>

<BR>

<FONT color=gray>Back to the packers' section</FONT>

<BR><BR>





<!-- OR JUST A LINK LIKE THIS -->



<!--

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="project1.htm" tppabs="http://www.anticrack.de/fravia/project1.htm">Back to Your_chosen_project</A> 

<hr width=33%>

-->



<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="index.html" tppabs="http://www.anticrack.de/fravia/index.html">homepage</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="links.htm" tppabs="http://www.anticrack.de/fravia/links.htm">links</A> 

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="searengi.htm" tppabs="http://www.anticrack.de/fravia/searengi.htm">search_forms</A>



<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="orc.htm" tppabs="http://www.anticrack.de/fravia/orc.htm">+ORC</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="student.htm" tppabs="http://www.anticrack.de/fravia/student.htm">students' essays</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="academy.htm" tppabs="http://www.anticrack.de/fravia/academy.htm">academy database</A>

<BR>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="realicra.htm" tppabs="http://www.anticrack.de/fravia/realicra.htm">reality cracking</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="howtosea.htm" tppabs="http://www.anticrack.de/fravia/howtosea.htm">how to search</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="javascri.htm" tppabs="http://www.anticrack.de/fravia/javascri.htm">javascript wars</A>

<BR>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="tools.htm" tppabs="http://www.anticrack.de/fravia/tools.htm">tools</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="noanon.htm" tppabs="http://www.anticrack.de/fravia/noanon.htm">anonymity academy</A> 

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="cocktail.htm" tppabs="http://www.anticrack.de/fravia/cocktail.htm">cocktails</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="ideale.htm" tppabs="http://www.anticrack.de/fravia/ideale.htm">antismut CGI-scripts</A>



<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="info.htm" tppabs="http://www.anticrack.de/fravia/info.htm">mail_fravia+</A>

<BR>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="legal.htm" tppabs="http://www.anticrack.de/fravia/legal.htm">Is reverse engineering legal?</A>

</CENTER>

<HR>

<!-- THAT'S ALL, THANKS A LOT this will allow automated retrieval -->

</BODY>

</HTML>