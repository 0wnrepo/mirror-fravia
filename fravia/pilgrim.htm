<HTML>

<HEAD>

<TITLE>pilgrim.htm FlexLmPC</TITLE>

</HEAD>

<BODY BGCOLOR=#C0C0C0 TEXT=#001010 VLINK=#405040>

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%  HEIGHT=" 22">

<TR><td></td>

<td>

<!-- Choose  a TITLE probably wont be changed -->

<center><FONT SIZE="+2">How to crack a PC-based FlexLm license manager</fonT><br></center>

</td>

<td>

<!-- Choose  a PROJECT GIF, leave this if unsure -->

<center><a href="student.htm#student_loo_na" tppabs="http://www.anticrack.de/fravia/student.htm#student_loo_na"><IMG SRC="notassi3.gif" tppabs="http://www.anticrack.de/fravia/notassi3.gif" ALT="student" 

ALIGN=CENTER WIDTH=114 HEIGHT=43 BORDER=0 VSPACE=0 HSPACE=0></a>

<br>

<font color=gray>Not Assigned</FonT>

</center></td></tr>

<tR>

<td bgcolor="#FFFFEA"><center>

<FONT COLOR="890000">

<!-- CHOOSE A DATE (will probably be changed) -->

30 October 1998

</FONT></center>

</td>

<td bgcolor="#FFFFEA"><center>by <font size=+3>

<!-- CHOOSE A HANDLE (wont be changed) -->

pilgrim





</fonT></center>





</td>





<td VALIGN="center" bgcolor="#FFFFEA">





<!--





<a href="hcu98_3.htm" tppabs="http://www.anticrack.de/fravia/hcu98_3.htm"><IMG SRC="hcu1.gif" tppabs="http://www.anticrack.de/fravia/hcu1.gif" ALT="+cracker" ALIGN=BOTTOM 





WIDTH=114 HEIGHT=43 BORDER=0 VSPACE=0 HSPACE=0></a>





-->





</td>





</tr>





<TR><td><center><a href="index.html" tppabs="http://www.anticrack.de/fravia/index.html"><IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif"

ALIGN="BOTTOM" 





BORDER="0" VSPACE="0" HSPACE="0" width="13" height="13"></a></center></td>





<TD BGCOLOR="898030"><center>Courtesy of Fravia's page of 





reverse engineering</center> 

</center></TD>

<td BGCOLOR="898030">

<center></center></td>

</TR>

<!-- this is for the data.....fra_00xx....yymmdd....handle..beg+int...not ass... -->





<tr><td><font

color="#C4C0CF">fra_00xx<bR>981030<br>Pilgrim<br>0100<br>NA<br>PC<br></fonT></td><td><i><center>





<!-- Your truly+ comments -->

A 'target unrelated' nice intermediate essay. Read and enjoy.



</i></center></td>





<td></td>





</tr>





<TR><td></td>





<!-- Leonard Coehn's old song, because we are poets, not only crackers

-->





<TD BGCOLOR="898030"><center></i><b>There is a crack, a crack in

everything 





That's how the light gets in</b></center>





<!-- Leonard Coehn's old song, because we are poets, not only crackers

-->





</center></TD><td></td>





</TR>





<TR>





<td VALIGN= "MIDDLE" bgcolor="#C6E7C6"><font color=blue><center>





Rating</FONT></FONT></center>





</TD>





<td VALIGN = "MIDDLE" bgcolor="#C6E7C6"><font color=blue><center>





<!-- CHOOSE A RATING (may be changed) -->





()<B>Beginner</B> (x)<B>Intermediate</B> ( )<B>Advanced</B> (

)<B>Expert</B></FONT>





</center></td>





<td></td>





</tr>





</table>





<!-- END HEAD  -->





<bR>





<!-- CORPUS  -->











<!-- CHOOSE A COMMENT (may be changed)  -->





<hR>





<center>





   <FONT SIZE="+2">





<!-- CHOOSE A TITLE (wont probably be changed) -->





How to hack a PC-based FlexLm license manager.





   </FONT><BR>





   <FONT SIZE="+2">





<!-- CHOOSE A SUBTITLE (wont proabbly be changed) -->





   </FONT><BR>





   <FONT COLOR="0B7FC1">





<!-- REPEAT YOUR CHOSEN HANDLE HERE -->Written by 





pilgrim





   </FONT>





</center><br><br>











<!-- INTRO STARTS HERE -->





<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%" 

HEIGHT="22" >





<tr><td bgcolor="#C6E7C6"><center><font size=+2><font

color=blue>Introduction</fonT>





</fonT></center></td></tr></table>





<br>

This article was inspired by the tutorial by SiuL+Hacky ( <A

HREF="siulflex.htm" tppabs="http://www.anticrack.de/fravia/siulflex.htm">siulflex.htm</A> ) on how to hack XprismPro 1.0<br>

The above program ran on Linux, but my target ran on Windows 95/NT

The aim of this tutorial is to expand on some of the ideas in the

first tutorial

and to detail the differences encountered on the PC.

<br><br>











<!-- TOOLS STARTS HERE -->





<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%" 

HEIGHT="22" >





<tr><td bgcolor="#C6E7C6"><center><font size=+2><font color=blue>Tools

required</fonT>





</fonT></center></td></tr></table>



W32DASM 8.9: everywhere <br>

Flexlm programmers kit: <a href="javascript:if(confirm('http://www.flexlm.com/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.flexlm.com/'" tppabs="http://www.flexlm.com/" target=_blank>http://www.flexlm.com</a>





<br><br>

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%" 

HEIGHT="22" >





<tr><td bgcolor="#C6E7C6"><center><font size=+2><font

color=blue>Essay</fonT></fonT>





</center></td></tr></table>



<pre>



1) Get hold of the flexlm programmers kit

==========================================



This is obtainable from www.flexlm.com

It needs a key to decrypt the file. 

S+H details how to crack it, or ask FlexLm.



Once you've got it installed the main files of interest are:



lm_code.h    : This is where you want to put in all the target key information

lm_client.h  : Contains useful function prototypes and error codes

GenLic32.exe : this program checks the keys and generates licenses for you.



I'd also recommend reading the html manual.



2) Find the easy information using lc_init()

============================================



Using W32DASM, decompile your target application and 

the vendor daemon DLL it uses ( e.g. lmgr326a.dll )



Load up the target EXE and set break points wherever the lc_init()

function is called.

Run your target until it breaks.



Looking at the prototype for lc_init in lm_client.h we see:



lm_extern API_ENTRY lc_init lm_args((LM_HANDLE_PTR job, 

                                     LM_CHAR_PTR vendor_id, 

                                     VENDORCODE_PTR vendor_key,

                                     LM_HANDLE_PTR_PTR job_id));



job will be NULL as it's the first one.

job_id will be a pointer for the job structure to be filled by the

function.



The things of interest for us are the vendor_id and vendor_key.

Vendor_id is just a text string.



Again looking in lm_client.h we see:



typedef struct vendorcode5 {

                            short type;    /* Type of structure */

                            unsigned long data[2]; /* 64-bit code */

                            unsigned long keys[4]; 

                            short flexlm_version;

                            short flexlm_revision;

                            char flexlm_patch[2];

                            char behavior_ver[LM_MAX_BEH_VER + 1];

                          } VENDORCODE5,  FAR *VENDORCODE_PTR;



#define LM_MAX_BEH_VER  "06.0"



In the above structure, 

data[0] = encryption seed 1 XORed with vendor key 5

data[1] = encryption seed 2 XORed with vendor key 5

keys[0..3]  = vendor keys 1 to 4

behavior_ver[] = string containing FlexLm version ( in this case = "06.0" )



So all the stuff above will be pushed onto the stack prior to calling lc_init.



Looking at the disassembly we see:



8B0F                    mov ecx, dword ptr [edi]

57                      push edi

68C88D5200              push 00528DC8      &lt;- pointer to code structure

* Possible StringData Ref from Data Obj ->"VENDOR"

68E45A5200              push 00525AE4      &lt;- pointer to vendor ID

string

51                      push ecx

* Reference To: LMGR326A.lc_init, Ord:0034h

E865E30600              Call 004A9BD8



OK, so we've got the vendor ID string ( in this case "VENDOR" )



And looking at memory address 00528DC8 we see the code structure:



[00528DC8] - 00000004  ....

[00528DCC] - ab5e32e5  .?^.    &lt;- seed 1 XORed with key5

[00528DD0] - 7bc6313d  =1.{    &lt;- seed 2 XORed with key5

[00528DD4] - fc62965d  ].l.    &lt;- key 1

[00528DD8] - 853df75c  \7=.    &lt;- key 2

[00528DDC] - 2f324f23  #O:.    &lt;- key 3

[00528DE0] - 1133e43b  ;.3.    &lt;- key 4

[00528DE4] - 00000006  ....    &lt;- version and revision

[00528DE8] - 36300069  i.06    &lt;- patch and behaviour_ver

[00528DEC] - 0000302e  .0..    &lt;- 



So we've got 4 keys and two XORed encryption keys.



4) Find your feature names

==========================



You need these to make up a working license file.

Clear the break-points on lc_init() function calls and set breaks on

calls to lc_checkout.



Looking at lm_client.h again we see:



lm_extern API_ENTRY lc_checkout lm_args((LM_HANDLE_PTR job, 

                                const LM_CHAR_PTR feature,

                                const LM_CHAR_PTR  version, 

                                int nlic, 

                                int flag, 

                                const VENDORCODE_PTR key, 

                                int dup));



The call looks like:



6800400000              push 00004000

68C88D5200              push 00528DC8                &lt;- code structure 

6A00                    push 00000000

8D442410                lea eax, dword ptr [esp+10]

6A01                    push 00000001

50                      push eax                     &lt;- version 

51                      push ecx                     &lt;- feature name

52                      push edx

* Reference To: LMGR326A.lc_checkout, Ord:0022h

E834AA0600              Call 004A9BDE



OK, so we've got a feature name.

Now have a look round and look for similar names, your target may use

more than one.



5) Make your first license.dat file

===================================



Modify the lm_code.h file to contain the encryption seeds, and vendor

keys 1 to 4.

Set vendor key 5 to 0 for now.



Run genlic32.exe

If it throws up an error message then you haven't typed in the keys

correctly in lm_code.h



Enter the feature name as found above.

Click on 'permanent' and 'run anywhere' so you don't need a server

daemon running.

Click on 'make license', fill in the filename license.dat and click

'Make license'



Have a look at the licence file, it'll look something like:



FEATURE full_spam_feature &lt;- feature name

VENDOR &lt;- vendor ID

1.000 &lt;- version

permanent &lt;- never expires

uncounted &lt;- no need for a server

0AF0103F59E2 &lt;- file checksum

HOSTID=ANY &lt;- run on any machine



6) Finding vendor key 5

=======================



Preamble...

Like S+H, I didn't believe vendor 5 could be unknown by the daemon, 

it had to be made on the fly.

It appears to be made up of all 4 vendor keys and the vendor name.

So it could be a checksum for the vendor info?

FlexLm provides the 5 keys based on your vendor name, so they'll want

to checksum it somehow.

If you get keys 1 to 4 or the vendor id wrong in lm_code.h then

genlic32.exe won't like it.

...



OK this bit is more tricky, but keep at it and you'll get there.



Start W32DASM again and load your target ready to read your nice new 

license file.

Break on lc_checkout in your target EXE.

Load up the daemon DLL ( in the active DLLs window double-click on the

daemon DLL ).

Start single-stepping through.

There's lots of calls to undocumented functions, but keep stepping

into them.



Here's the edited highlights of how it went for me:



Read and check the licence.dat file:

l_validversion(), l_compare_version() check the version in the license file

l_date(),l_extract_date() extract the date from the checksum 

( permanent gets converted into 1-jan-0 )

l_start_ok() start date is OK

l_host() OK 'cos it's ANY



Then we got into some functions with lots of XORs.

This looks good as we want to XOR our two encryption seeds.

We can see the keys 1,2,3 and 4 and the vendor ID getting read and XORed

Then we hit some code:



E8C2080100              call 10021160                 &lt;- get vendor key 5 in ebx

83C40C                  add esp, 0000000C

8B4704                  mov eax, dword ptr [edi+04]   &lt;- seed1 from license.dat

33C3                    xor eax, ebx                  &lt;- seed1 XOR key5  

8D4DA8                  lea ecx, dword ptr [ebp-58]   

51                      push ecx

8945AC                  mov dword ptr [ebp-54], eax   &lt;- store seed1

8B4708                  mov eax, dword ptr [edi+08]   &lt;- seed2 from license.dat

8B7D0C                  mov edi, dword ptr [ebp+0C]

33C3                    xor eax, ebx                  &lt;- seed2 XOR key5

8945B0                  mov dword ptr [ebp-50], eax   &lt;- store seed2

8D4754                  lea eax, dword ptr [edi+54]

50                      push eax

:100108BC 56                      push esi

* Reference To: LMGR326A.l_extract_date

:100108BD E8D642FFFF              call 10004B98



So we've just got key5, and the XORed seeds1 and 2



7) Make your final license.dat

==============================



In lm_code.h, replace your two seeds and key5

Run genlic32.exe and make your completed licence file.

</prE>





<br><br>

<!-- FINAL NOTES STARTS HERE -->

<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%" 

HEIGHT="22" >

<tr><td bgcolor="#C6E7C6"><center><font size=+2><font color=blue>Final

Notes</fonT></fonT></center></td></tr></table>                         

As Siul+Hacky mentioned, the only security here is that of secrecy.

Thanks to Siul+ for the initial hard work.

<br><br>

<!-- OB DUH STARTS HERE -->





<TABLE CELLPADDING="1" CELLSPACING="2" BORDER="1" WIDTH= "100%" 

HEIGHT="22" >





<tr><td bgcolor="#C6E7C6"><center><font size=+2><font color=blue>Ob

Duh</fonT></fonT>

</center></td></tr></table>

 <center>



   <i>I wont even bother explaining you that 

you should BUY this target program if you intend to use it for a longer 

period than the allowed one. Should you want to STEAL this software 

instead, you don't need to crack its protection scheme at all: you'll 

find it on most Warez sites, complete and already regged,

farewell.</i>

</center>

<!-- WAY OUT STARTS HERE -->

<hr>

<center><i>You are deep inside fravia's page of reverse engineering,  

choose your way out:</i></center>

<br><center>

<!-- EITHER A NICE GIF LIKE THIS -->

<!-- 

<a href="project3.htm" tppabs="http://www.anticrack.de/fravia/project3.htm"><IMG SRC="project3.gif" tppabs="http://www.anticrack.de/fravia/project3.gif" 

ALT="projecT3" ALIGN=CENTER WIDTH=114 HEIGHT=43 BORDER=0 VSPACE=0

HSPACE=0></a>

<br>

<font color=gray>Back to project 3</FonT>

<br><bR>

-->

<!--

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="project1.htm" tppabs="http://www.anticrack.de/fravia/project1.htm">Back to

Your_chosen_project</A> 

<hr width=33%>

-->



<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="index.html" tppabs="http://www.anticrack.de/fravia/index.html">homepage</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="links.htm" tppabs="http://www.anticrack.de/fravia/links.htm">links</A> 

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="searengi.htm" tppabs="http://www.anticrack.de/fravia/searengi.htm">search_forms</A>



<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="orc.htm" tppabs="http://www.anticrack.de/fravia/orc.htm">+ORC</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="student.htm" tppabs="http://www.anticrack.de/fravia/student.htm">students' essays</A>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 

BORDER=0 VSPACE=0 HSPACE=0><A HREF="academy.htm" tppabs="http://www.anticrack.de/fravia/academy.htm">academy database</A>

<br>

<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A HREF="realicra.htm" tppabs="http://www.anticrack.de/fravia/realicra.htm">reality cracking</A>





<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A HREF="howtosea.htm" tppabs="http://www.anticrack.de/fravia/howtosea.htm">how to search</A>





<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A HREF="javascri.htm" tppabs="http://www.anticrack.de/fravia/javascri.htm">javascript wars</A>





<br>





<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A HREF="tools.htm" tppabs="http://www.anticrack.de/fravia/tools.htm">tools</A>





<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A HREF="noanon.htm" tppabs="http://www.anticrack.de/fravia/noanon.htm">anonymity academy</A> 





<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A HREF="cocktail.htm" tppabs="http://www.anticrack.de/fravia/cocktail.htm">cocktails</A>





<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A

HREF="javascript:if(confirm('http://www.anticrack.de/fravia/-a href=  \n\nThis file was not retrieved by Teleport Pro, because the server reports that this file cannot be found.  \n\nDo you want to open it from the server?'))window.location='http://www.anticrack.de/fravia/-a href='" tppabs="http://www.anticrack.de/fravia/-a href=" target=_blank http://fravia.org/ideale.htm">http://fravia.org/ideale.htm</A>">antismut CGI-scripts</A>











<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A HREF="info.htm" tppabs="http://www.anticrack.de/fravia/info.htm">mail_fravia+</A>





<BR>





<IMG SRC="bulletr.gif" tppabs="http://www.anticrack.de/fravia/bulletr.gif" ALT="red" ALIGN=BOTTOM WIDTH=13 HEIGHT=13 





BORDER=0 VSPACE=0 HSPACE=0><A HREF="legal.htm" tppabs="http://www.anticrack.de/fravia/legal.htm">Is reverse engineering

legal?</A>





</CENTER>





<HR>





<!-- THAT'S ALL, THANKS A LOT this will allow automated retrieval -->





</BODY>





</HTML>

